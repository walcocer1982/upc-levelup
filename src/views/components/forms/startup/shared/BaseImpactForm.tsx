"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import { Textarea } from "@/components/ui/textarea";
import { useState, useEffect, useCallback } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { toast } from "sonner";

const impactSchema = z.object({
  // Criterio 1: Nivel de complejidad de la situaci√≥n que resuelven
  casoReal: z.string().optional(),
  abordajeProblema: z.string().optional(),
  consecuencias: z.string().optional(),
  afectados: z.string().optional(),

  // Criterio 2: Tama√±o de mercado
  tamanoMercado: z.string().optional(),
  potencialesClientes: z.string().optional(),
  interesPagar: z.string().optional(),
  segmentoInteres: z.string().optional(),

  // Criterio 3: Potencial de escalar
  estrategiaAdquisicion: z.string().optional(),
  costoAdquisicion: z.string().optional(),
  facilidadExpansion: z.string().optional(),
  escalabilidad: z.string().optional(),

  // Criterio 4: Equipo emprendedor
  trayectoria: z.string().optional(),
  experiencia: z.string().optional(),
  roles: z.string().optional(),
  desafios: z.string().optional(),
});

type ImpactFormValues = z.infer<typeof impactSchema>;

interface BaseImpactFormProps {
  onSubmit: (data: ImpactFormValues) => void;
  initialData?: Partial<ImpactFormValues>;
  startupId?: string;
  mode?: 'admin' | 'user';
  title?: string;
  submitButtonText?: string;
  onCancel?: () => void;
  showCancelButton?: boolean;
}

export default function BaseImpactForm({ 
  onSubmit, 
  initialData, 
  startupId,
  mode = 'user',
  title = "Impacto de tu Startup",
  submitButtonText = "Guardar Impacto",
  onCancel,
  showCancelButton = false
}: BaseImpactFormProps) {
  const [activeSection, setActiveSection] = useState(1);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<ImpactFormValues>({
    resolver: zodResolver(impactSchema),
    defaultValues: initialData || {
      // Criterio 1
      casoReal: "",
      abordajeProblema: "",
      consecuencias: "",
      afectados: "",

      // Criterio 2
      tamanoMercado: "",
      potencialesClientes: "",
      interesPagar: "",
      segmentoInteres: "",

      // Criterio 3
      estrategiaAdquisicion: "",
      costoAdquisicion: "",
      facilidadExpansion: "",
      escalabilidad: "",

      // Criterio 4
      trayectoria: "",
      experiencia: "",
      roles: "",
      desafios: "",
    },
  });

  // Cargar datos existentes al montar el componente
  const loadImpactData = useCallback(async () => {
    if (!startupId) {
      console.log("üîÑ Sin startupId, formulario vac√≠o");
      return;
    }

    try {
      console.log("üîç Cargando impact para startup:", startupId);
      setIsLoading(true);

      const response = await fetch(`/api/startups/impact?startupId=${startupId}`);

      if (response.ok) {
        const data = await response.json();
        console.log("‚úÖ Datos de impacto cargados:", data);
        
        if (data.impact) {
          form.reset(data.impact);
        }
      } else {
        console.log("‚ö†Ô∏è No se encontraron datos de impacto");
      }
    } catch (error) {
      console.error('Error al cargar datos de impacto:', error);
      toast.error("Error al cargar los datos de impacto");
    } finally {
      setIsLoading(false);
    }
  }, [startupId, form]);

  useEffect(() => {
    loadImpactData();
  }, [loadImpactData]);

  const handleSubmit = async (data: ImpactFormValues) => {
    try {
      setIsSubmitting(true);
      console.log("üöÄ Enviando datos de impacto:", data);

      const apiUrl = `/api/startups/impact`;
      const method = startupId ? 'PUT' : 'POST';
      const body = { startupId, ...data };

      const response = await fetch(apiUrl, {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(body),
      });

      if (response.ok) {
        const result = await response.json();
        console.log("‚úÖ Impacto guardado exitosamente:", result);
        toast.success("Datos de impacto guardados exitosamente");
        onSubmit(data);
      } else {
        const errorData = await response.json();
        console.error("‚ùå Error al guardar impacto:", errorData);
        toast.error(errorData.error || "Error al guardar los datos");
      }
    } catch (error) {
      console.error("‚ùå Error en el env√≠o:", error);
      toast.error("Error de conexi√≥n");
    } finally {
      setIsSubmitting(false);
    }
  };

  const getSectionFields = (section: number): (keyof ImpactFormValues)[] => {
    switch (section) {
      case 1:
        return ['casoReal', 'abordajeProblema', 'consecuencias', 'afectados'];
      case 2:
        return ['tamanoMercado', 'potencialesClientes', 'interesPagar', 'segmentoInteres'];
      case 3:
        return ['estrategiaAdquisicion', 'costoAdquisicion', 'facilidadExpansion', 'escalabilidad'];
      case 4:
        return ['trayectoria', 'experiencia', 'roles', 'desafios'];
      default:
        return [];
    }
  };

  const getSectionData = (data: ImpactFormValues, section: number) => {
    const fields = getSectionFields(section);
    return fields.reduce((acc, field) => {
      acc[field] = data[field];
      return acc;
    }, {} as Partial<ImpactFormValues>);
  };

  const renderTextareaField = (
    name: keyof ImpactFormValues,
    label: string,
    placeholder: string
  ) => (
    <FormField
      control={form.control}
      name={name}
      render={({ field }) => (
        <FormItem>
          <FormLabel>{label}</FormLabel>
          <FormControl>
            <Textarea
              placeholder={placeholder}
              className="min-h-[100px]"
              {...field}
            />
          </FormControl>
          <FormMessage />
        </FormItem>
      )}
    />
  );

  const sections = [
    {
      id: 1,
      title: "Problema y Soluci√≥n",
      description: "Describe el problema que resuelves y c√≥mo lo abordas"
    },
    {
      id: 2,
      title: "Mercado y Clientes",
      description: "Define tu mercado objetivo y validaci√≥n de clientes"
    },
    {
      id: 3,
      title: "Escalabilidad",
      description: "Estrategias de crecimiento y expansi√≥n"
    },
    {
      id: 4,
      title: "Equipo",
      description: "Experiencia y capacidades del equipo"
    }
  ];

  if (isLoading) {
    return (
      <div className="w-full max-w-4xl mx-auto">
        <div className="bg-card p-6 rounded-lg shadow-sm border">
          <div className="animate-pulse space-y-4">
            <div className="h-8 bg-muted rounded w-1/3"></div>
            <div className="space-y-3">
              <div className="h-4 bg-muted rounded"></div>
              <div className="h-4 bg-muted rounded w-5/6"></div>
              <div className="h-4 bg-muted rounded w-4/6"></div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="w-full max-w-4xl mx-auto">
      <div className="bg-card p-6 rounded-lg shadow-sm border">
        <div className="mb-6">
          <h1 className="text-xl sm:text-2xl font-bold">{title}</h1>
          <p className="text-muted-foreground mt-2">
            Completa la informaci√≥n sobre el impacto de tu startup
          </p>
        </div>

        {/* Navegaci√≥n de secciones */}
        <div className="mb-6">
          <div className="flex flex-wrap gap-2">
            {sections.map((section) => (
              <button
                key={section.id}
                onClick={() => setActiveSection(section.id)}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                  activeSection === section.id
                    ? "bg-primary text-primary-foreground"
                    : "bg-muted text-muted-foreground hover:bg-muted/80"
                }`}
              >
                {section.title}
              </button>
            ))}
          </div>
        </div>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(handleSubmit)} className="space-y-6">
            {/* Secci√≥n activa */}
            <Card>
              <CardContent className="pt-6">
                <div className="mb-4">
                  <h2 className="text-lg font-semibold">
                    {sections.find(s => s.id === activeSection)?.title}
                  </h2>
                  <p className="text-sm text-muted-foreground">
                    {sections.find(s => s.id === activeSection)?.description}
                  </p>
                </div>

                <div className="space-y-4">
                  {activeSection === 1 && (
                    <>
                      {renderTextareaField(
                        "casoReal",
                        "Caso Real",
                        "Describe un caso real o situaci√≥n espec√≠fica que tu startup resuelve. ¬øQu√© problema enfrentaban las personas o empresas antes de tu soluci√≥n?"
                      )}
                      {renderTextareaField(
                        "abordajeProblema",
                        "Abordaje del Problema",
                        "¬øC√≥mo abordas este problema? ¬øCu√°l es tu enfoque √∫nico para resolverlo?"
                      )}
                      {renderTextareaField(
                        "consecuencias",
                        "Consecuencias del Problema",
                        "¬øQu√© impacto negativo (p√©rdidas de tiempo, dinero, oportunidades, etc.) experimentaban al no tener una soluci√≥n efectiva para esta situaci√≥n? Si es posible, cuantifica estas consecuencias."
                      )}
                      {renderTextareaField(
                        "afectados",
                        "Personas Afectadas",
                        "¬øCu√°ntas personas o empresas se ven afectadas por este problema? ¬øQui√©nes son los principales afectados?"
                      )}
                    </>
                  )}

                  {activeSection === 2 && (
                    <>
                      {renderTextareaField(
                        "tamanoMercado",
                        "Tama√±o del Mercado",
                        "Describe el tama√±o de tu mercado objetivo. ¬øCu√°ntos clientes potenciales existen?"
                      )}
                      {renderTextareaField(
                        "potencialesClientes",
                        "Clientes Potenciales",
                        "¬øQui√©nes son tus clientes potenciales? ¬øC√≥mo los has identificado y validado?"
                      )}
                      {renderTextareaField(
                        "interesPagar",
                        "Inter√©s en Pagar",
                        "¬øHas validado que tus clientes potenciales est√°n dispuestos a pagar por tu soluci√≥n? ¬øC√≥mo lo has verificado?"
                      )}
                      {renderTextareaField(
                        "segmentoInteres",
                        "Segmento de Inter√©s",
                        "¬øCu√°l es el segmento de clientes m√°s interesado en tu soluci√≥n? ¬øPor qu√©?"
                      )}
                    </>
                  )}

                  {activeSection === 3 && (
                    <>
                      {renderTextareaField(
                        "estrategiaAdquisicion",
                        "Estrategia de Adquisici√≥n",
                        "¬øCu√°l es tu estrategia para adquirir nuevos clientes? ¬øQu√© canales utilizar√°s?"
                      )}
                      {renderTextareaField(
                        "costoAdquisicion",
                        "Costo de Adquisici√≥n",
                        "¬øCu√°l es el costo estimado para adquirir un nuevo cliente? ¬øC√≥mo planeas optimizarlo?"
                      )}
                      {renderTextareaField(
                        "facilidadExpansion",
                        "Facilidad de Expansi√≥n",
                        "¬øQu√© tan f√°cil es expandir tu soluci√≥n a nuevos mercados o segmentos? ¬øCu√°les son los principales desaf√≠os?"
                      )}
                      {renderTextareaField(
                        "escalabilidad",
                        "Estrategias de Escalabilidad",
                        "¬øQu√© estrategias tienes para escalar tu negocio? ¬øC√≥mo planeas crecer de manera sostenible?"
                      )}
                    </>
                  )}

                  {activeSection === 4 && (
                    <>
                      {renderTextareaField(
                        "trayectoria",
                        "Trayectoria del Equipo",
                        "¬øCu√°l es la trayectoria profesional de los miembros del equipo? ¬øQu√© experiencia relevante tienen?"
                      )}
                      {renderTextareaField(
                        "experiencia",
                        "Experiencia en el Sector",
                        "¬øQu√© experiencia espec√≠fica tiene el equipo en el sector o industria de tu startup?"
                      )}
                      {renderTextareaField(
                        "roles",
                        "Roles y Responsabilidades",
                        "¬øC√≥mo est√°n distribuidos los roles en el equipo? ¬øQui√©n se encarga de qu√© √°reas?"
                      )}
                      {renderTextareaField(
                        "desafios",
                        "Superaci√≥n de Desaf√≠os",
                        "¬øQu√© desaf√≠os importantes ha superado el equipo? ¬øC√≥mo han demostrado resiliencia y capacidad de adaptaci√≥n?"
                      )}
                    </>
                  )}
                </div>
              </CardContent>
            </Card>

            {/* Navegaci√≥n entre secciones */}
            <div className="flex justify-between">
              <Button
                type="button"
                variant="outline"
                onClick={() => setActiveSection(Math.max(1, activeSection - 1))}
                disabled={activeSection === 1}
              >
                Anterior
              </Button>

              <div className="flex gap-2">
                {activeSection < 4 && (
                  <Button
                    type="button"
                    onClick={() => setActiveSection(activeSection + 1)}
                  >
                    Siguiente
                  </Button>
                )}
                
                {activeSection === 4 && (
                  <>
                    {showCancelButton && onCancel && (
                      <Button
                        type="button"
                        variant="outline"
                        onClick={onCancel}
                        disabled={isSubmitting}
                      >
                        Cancelar
                      </Button>
                    )}
                    <Button type="submit" disabled={isSubmitting}>
                      {isSubmitting ? "Guardando..." : submitButtonText}
                    </Button>
                  </>
                )}
              </div>
            </div>
          </form>
        </Form>
      </div>
    </div>
  );
} 